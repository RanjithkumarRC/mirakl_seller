<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">
    <link rel="stylesheet" href="include/css/bootstrap.min.css">
    <link rel="stylesheet" href="include/css/style.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="include/js/bootstrap.bundle.min.js"></script>
    <script src="include/js/jquery.min.js"></script>
    <script src="include/js/bootstrap.min.js"></script>
    <script src="include/js/script.js"></script>
    <script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
    <title>RC Mirakl Connector - Seller</title>
</head>
<body class="footer-relative">
    <div class="main-wrapper cust_loader cust_loader_off">
      <button class="btn btn-primary" type="button" disabled>
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Loading...
      </button>
    </div>
  <div class="db__wraper" id="body-pd">
    <header class="header" id="header">
      <div class="header_toggle">
        <i class='bx bx-menu' id="header-toggle"></i>
      </div>
      <div class="header_toggle">
        <a href="dashboard?data={{storehash}}">RC Mirakl Connector - Seller</a>
      </div>
      <div class="header_img">
        <a href="settings?data={{storehash}}">
          <i class='bx bxs-cog'></i>
        </a>
      </div>
    </header>
    <div class="l-navbar" id="nav-bar">
      <nav class="nav">
        <div>
          <div class="nav_list">
            <a href="product-sync-BCtoMirakl?data={{storehash}}" class="nav_link">
              <i class='bx bx-cube'></i>
              <span class="nav_name">Seller-Product-sync</span>
            </a>
            <a href="offer-sync-BCtoMirakl?data={{storehash}}" class="nav_link">
              <i class='bx bxs-offer'></i>
              <span class="nav_name">Seller-Offer-sync</span>
            </a>
            <a href="order-sync-BCtoMirakl?data={{storehash}}" class="nav_link">
              <i class='bx bx-cart-add'></i>
              <span class="nav_name">Seller-Order-sync</span>
            </a>
          </div>
        </div>
      </nav>
    </div>
    <!--Container Main start-->
    <main class="col-md-11 ms-sm-auto col-lg-12 px-md-1">
      <input type="hidden" id="cust_data" name="cust_data" value="{{storehash}}">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2 page-title txt-upp">Seller Offer Sync</h1>
      </div>
      <div class="row">
        <div class="col-xl-12 col-lg-12">
          <div class="row">
            <div class="col-lg-3">
              <div class="card widget-flat mb-3">
                <div class="card-body">
                  <!-- <h4 class="header-title mb-3">Summary</h4> -->
                  <div class="summarybar_wrrpaer">
                    <div class="summarybar_content">
                        <h5>Offers (BiC to Mirakl)</h5>
                        <a href="javascript:void(0);" class="offer_sync_bc_mirakl">
                        <div class="d-flex align-items-center border border-medium rounded p-2 mb-2">
                          <div class="flex-shrink-0 me-2">
                            <i class='bx bx-sync bx-sm widget-icon rounded-circle'></i>
                          </div>
                          <span class="fw-semibold">Synchronize</span>    
                        </div>
                      </a>
                    </div> 
                  </div>
                  <div class="summarybar_wrrpaer">
                    <div class="summarybar_content">
                      <h5>Offer Import Status Sync</h5>
                      <a href="javascript:void(0);" class="offer_import_status_sync">
                        <div class="d-flex align-items-center border border-medium rounded p-2 mb-2">
                          <div class="flex-shrink-0 me-2">
                            <i class='bx bx-sync bx-sm widget-icon rounded-circle'></i>
                          </div>
                          
                          <span class="fw-semibold">Synchronize</span>    
                        </div>
                      </a>
                    </div> 
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-9">
              <div class="card widget-flat mb-3">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-centered mb-0" id="offer-table">
                            <thead>
                                <tr>
                                    <th>Sl. No</th>
                                    <th>Product Name</th>
                                    <th>Shop SKU</th>
                                    <th>Variant SKU</th>
                                    <th>Qty</th>
                                    <th>Offer price</th>
                                    <th>Discount Price</th>
                                    <th>Created At</th>
                                    <th>Action/Satus</th>
                                </tr>
                            </thead>
                            <tbody>
                              {{#each import_files_array}}
                              <tr>
                                <td >{{index}}</td>
                                <td class="table-user">
                                  {{product_name}}
                                </td>
                                <td>{{offer_sku}}</td>
                                {{#if variant_sku '!==' 0}}
                                <td>{{variant_sku}}</td>
                                {{else}}
                                <td>-</td>
                                {{/if}}
                                <td>{{qty}}</td>
                                <td>{{offer_price}}</td>
                                {{#if offer_discount_price '!==' 0}}
                                <td>{{offer_discount_price}}</td>
                                {{else}}
                                <td>-</td>
                                {{/if}}
                                <td>{{created}}</td>
                                <td class="table-action">
                                    <a class="btn btn-primary view_info" data-id="{{import_id}}" data-bs-toggle="modal" href="#exampleModalToggle" role="button">View</a>
                                </td>
                            </tr>
                              {{/each}}
<!-- 
                                <tr>
                                    <td >1</td>
                                    <td class="table-user">
                                        Samsung Galaxy Z Flip4 256GB+8GB RAM
                                    </td>
                                    <td>2176</td>
                                    <td>111000</td>
                                    <td>799.00</td>
                                    <td>1099.00</td>
                                    <td class="table-action">
                                        <a class="btn btn-primary view_info" data-id="2176" data-bs-toggle="modal" href="#exampleModalToggle" role="button">View</a>
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td >1</td>
                                    <td class="table-user">
                                        Apple iPhone XS 64GB
                                    </td>
                                    <td>S2208</td>
                                    <td>100,011</td>
                                    <td>799.00</td>
                                    <td>1099.00</td>
                                    <td class="table-action">
                                        <a class="btn btn-primary view_info" data-id="2184" data-bs-toggle="modal" href="#exampleModalToggle" role="button">View</a>
                                    </td>
                                </tr> 
                                 -->
                            </tbody>
                        </table>
                    </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
<!-- Modal start -->
    <div class="modal fade" id="exampleModalToggle" aria-hidden="true" aria-labelledby="exampleModalToggleLabel" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalToggleLabel">Seller Offer Sync Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <table class="table">
                    <thead>
                      <tr>
                        <th scope="col">Sl. No</th>
                        <th scope="col">Import ID</th>
                        <th scope="col">Status</th>
                        <th scope="col">Origin</th>
                        <th scope="col">Error Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      
                    </tbody>
                </table>
          </div>
        </div>
      </div>
    </div>
<!-- Modal End -->

  </div>
  <footer class="border-top footer">
    <p class="text-center text-muted">Copywrite @2023 Royal Cyber Inc. All rights reserved</p>
</footer>
  <script>
    $(document).ready(function(){
      var cust_data = $('#cust_data').val();
      var current_storehash = {data:cust_data};
        $('#offer-table').DataTable({});

        $(".offer_sync_bc_mirakl").on("click",function(){
          $('.cust_loader').addClass('cust_loader_on');
          $('.cust_loader').removeClass('cust_loader_off');
          $.ajax({url: "https://apps.royalcyber.org/mirakl_seller/crons/create_offers_BCtoMirakl.php", data: current_storehash, success: function(result){
            alert(result);
            $('.cust_loader').removeClass('cust_loader_on');
            $('.cust_loader').addClass('cust_loader_off');
            location.reload(true);
          }});
        });

        $("body").on("click", ".offer_import_status_sync", function(event){
              $('.cust_loader').addClass('cust_loader_on');
              $('.cust_loader').removeClass('cust_loader_off');
              $.ajax({url: "https://apps.royalcyber.org/mirakl_seller/crons/offers_bc_mirakl_sync_status.php", data: current_storehash, success: function(result){
                $('.cust_loader').removeClass('cust_loader_on');
                $('.cust_loader').addClass('cust_loader_off');
                location.reload(true);
              }});
            });

        $(".view_info").on("click",function(){
          var import_id = $(this).attr('data-id');
          // alert(import_id);
          var err_flag = 0;
          var datas = {data:cust_data,data_id:import_id,err_report:err_flag};
          $('.cust_loader').addClass('cust_loader_on');
          $('.cust_loader').removeClass('cust_loader_off');
          $.ajax({url: "https://apps.royalcyber.org/mirakl_seller/api/get_seller_offer_import_status.php", data: datas, success: function(result){
            var obj = JSON.parse(result);
            console.log(obj);
            if(obj.import_id){
          $(".modal-body .table tbody").html(makedata(obj));
            }
            else{
              $(".modal-body .table tbody").html("No data");
            }
            $('.cust_loader').removeClass('cust_loader_on');
            $('.cust_loader').addClass('cust_loader_off');
          },
          error: function(XMLHttpRequest, textStatus, errorThrown) { 
                    console.log("Status: " + textStatus); alert("Error: " + errorThrown); 
                }  });
        });

        
          $(document).on('click', '.dwn_view_info', function(){ 
          var import_id = $(this).attr('data-id');
          var err_flag = 1;
          var datas = {data:cust_data,data_id:import_id,err_report:err_flag};

      $.ajax({url: "https://apps.royalcyber.org/mirakl_seller/api/get_seller_offer_import_status.php", data: datas, success: function(result){
            console.log(result);
            var contentType = 'text/csv';
            const blob = new Blob([result], {type: contentType});
            const downloadUrl = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = downloadUrl;
            a.download = "error-report.csv";
            document.body.appendChild(a);
              a.click();

          },
          error: function(XMLHttpRequest, textStatus, errorThrown) { 
                    console.log("Status: " + textStatus); alert("Error: " + errorThrown); 
                }  });

        });

      function makedata(json) {
      let htmlTable = "";
      htmlTable += "<tr>";
      htmlTable += "<th scope='row'>" + "1" + "</th>";
      htmlTable += "<td>" + json.import_id + "</td>";
      htmlTable += "<td><div class='label__st'>";
      if(json.status=="SENT"){
      htmlTable += "<span class='label org_color'>" + json.status + "</span>";
      }else if(json.status=="COMPLETE"){
      htmlTable += "<span class='label grn_color'>" + json.status + "</span>";
      }else{
      htmlTable += "<span class='label'>" + json.status + "</span>";
      }
      
      htmlTable += "<ul class='label__msg'>";
      htmlTable += "<li class='sucess_color'>Lines Read: " + json.lines_read + "</li>";
      htmlTable += "<li class='sucess_color'>Lines Pending: " + json.lines_in_pending + "</li>";
      htmlTable += "<li class='sucess_color'>Lines success: " + json.lines_in_success + "</li>";
      htmlTable += "<li class='text-danger'>Lines Error: " + json.lines_in_error + "</li>";
      htmlTable += "</ul>";
      htmlTable += "</div></td>";
      htmlTable += "<td>" + json.type + "</td>";
        if(json.error_report){

          htmlTable += "<td><div class='files_dwnld'>" + "<a href='#' class='dwn_view_info' data-id='" + json.import_id +"'><i class='bx bx-download'></i><span>Download error file</span></a>" + "</div></td>";
          
              }
       htmlTable += "</tr>";

      return htmlTable;
      }

      function convertToCSV(objArray) {
    var array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
    var str = '';

    for (var i = 0; i < array.length; i++) {
        var line = '';
        for (var index in array[i]) {
            if (line != '') line += ','

            line += array[i][index];
        }

        str += line + '\r\n';
    }

    return str;
}

function exportCSVFile(headers, items, fileTitle) {
    if (headers) {
        items.unshift(headers);
    }

    // Convert Object to JSON
    var jsonObject = JSON.stringify(items);

    var csv = this.convertToCSV(jsonObject);

    var exportedFilenmae = fileTitle + '.csv' || 'export.csv';

    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    if (navigator.msSaveBlob) { // IE 10+
        navigator.msSaveBlob(blob, exportedFilenmae);
    } else {
        var link = document.createElement("a");
        if (link.download !== undefined) { // feature detection
            // Browsers that support HTML5 download attribute
            var url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", exportedFilenmae);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
}

    });
</script>
  </body>
</html>